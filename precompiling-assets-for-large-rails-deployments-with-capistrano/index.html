<!doctype html> <html class=no-js lang=en> <head> <title>Precompiling Assets for Large Rails Deployments with Capistrano | Sourcey</title> <meta charset=utf-8 /> <meta name=viewport content="width=device-width, initial-scale=1.0"/> <meta name=google-site-verification content=lC7-hHwqtiRqo7YTHc1fJ6t8ie-Hs7J4o5u3XRIF9Vw /> <link rel=alternate type="application/atom+xml" title="Atom Feed" href="/feed.xml"/> <link href="/stylesheets/app.css" media=screen rel=stylesheet /> <script src="/javascripts/all.js"></script> <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script> <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-836728-7', 'sourcey.com');
      ga('send', 'pageview');
    </script> </head> <body class="article precompiling-assets-for-large-rails-deployments-with-capistrano precompiling-assets-for-large-rails-deployments-with-capistrano_index"> <nav class=top-bar data-topbar=""> <div class=top-bar-inner> <div id=social> <a rel="nofollow" href="https://github.com/sourcey"><i class=fi-social-github></i></a> <a href="https://twitter.com/sourceydevel"><i class=fi-social-twitter></i></a> <a href="https://plus.google.com/+SourceyDevel"><i class=fi-social-google-plus></i></a> <a href="https://facebook.com/sourceydevel"><i class=fi-social-facebook></i></a> </div> <ul class=title-area> <li class=name></li> <li class="toggle-topbar menu-icon"><a href="#" class=left></a></li> </ul> <section class=top-bar-section style="left: 0%;"> <ul class=left> <li class=home><a href="/">Home</a></li> <li class=has-dropdown><a href="/#projects">Projects</a> <ul class=dropdown><li class="title back js-generated"><h5><a href="javascript:void(0)">Back</a></h5></li> <li> <a href="/libsourcey"><b>LibSourcey</b><small>C++ networking evolved</small></a> </li> <li> <a href="/symple"><b>Symple</b><small>Messaging made Symple</small></a> </li> <li> <a href="/precompiled-webrtc-libraries"><b>WebRTC Builds</b><small>Precompiled WebRTC libraries</small></a> </li> <li> <a href="/anionu"><b>Anionu</b><small>Cloud video surveillance</small></a> </li> <li> <a href="http://stompstart.com"><b>StompStart</b><small>Promote your startup</small></a> </li> <li> <a href="/mesh"><b>Mesh</b><small>Elegant, modern design</small></a> </li> <li> <a href="/pacm"><b>Pacm</b><small>Redistributable package manager</small></a> </li> <li> <a href="/pluga"><b>Pluga</b><small>C++ plugin system</small></a> </li> <li> <a href="http://artzine.com"><b>Artzine</b><small>European Art Gallery and Marketplace</small></a> </li> <li> <a href="/recliner"><b>Recliner.js</b><small>Flexible lazy loading</small></a> </li> </ul> </li> <li class=has-dropdown><a href="/#articles">Articles</a> <ul class=dropdown> <li><a href="/archives">Archives</a></li> <li><a href="/feed.xml">Feed</a></li> </ul> </li> <li><a href="mailto:hello@sourcey.com">Contact</a></li> <li class=divider></li> </ul> </section> </div> </nav> <div id=main role=main> <article> <header class=article-header> <h1>Precompiling Assets for Large Rails Deployments with Capistrano</h1> <div class=meta> <a rel="author external" class=author href="https://plus.google.com/+KamLow">Kam Low</a> &mdash; <time class=updated datetime="May 20 2014">May 20 2014</time> <div class=tags> <a href="/tags/capistrano/">Capistrano</a>, <a href="/tags/rails/">Rails</a>, <a href="/tags/productivity/">Productivity</a> </div> </div> </header> <div class="article-wrap row"> <div class="large-8 columns"> <div class=content> <!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN" "http://www.w3.org/TR/REC-html40/loose.dtd"> <html><body> <p><img alt=Capistrano title=Capistrano src="/images/logos/capistrano-600x228.png"></p> <p>If you’ve ever had to deploy a large Rails site using Capistrano, then you’re probably aware of how time consuming it is to precompile the assets pipeline on the server-side.</p> <p>This is not really an issue for a small sites with a few images and JavaScripts, but when it starts taking upwards of half an hour to roll out a small or time critical patch you know somethings gotta give!</p> <p>Some people store compiled assets using <code>git</code> in either the master or a separate repository, but that’s kind of overkill and it also introduces an extra step. The most efficient way is just to use Capistrano’s <code>run_locally</code> command to compile assets on the local machine and then <code>rsync</code> them to the remote server.</p> <p>The following Capistrano script is what we currently use on a Rails 3.2 site, but it should work with other Rails versions too. Stick the following task somewhere in your <code>deploy.rb</code>:</p> <div class=highlight><pre class="highlight ruby"><code><span class="n">namespace</span> <span class="ss">:deploy</span> <span class="k">do</span>
  <span class="n">namespace</span> <span class="ss">:assets</span> <span class="k">do</span>
   <span class="n">desc</span> <span class="s2">"Precompile assets locally and then rsync to deploy server"</span>
    <span class="n">task</span> <span class="ss">:precompile</span><span class="p">,</span> <span class="ss">:only</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="ss">:primary</span> <span class="o">=&gt;</span> <span class="kp">true</span> <span class="p">}</span> <span class="k">do</span>
      <span class="n">run_locally</span> <span class="s2">"bundle exec rake assets:precompile"</span>
      <span class="n">servers</span> <span class="o">=</span> <span class="n">find_servers</span> <span class="ss">:roles</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="ss">:app</span><span class="p">],</span> <span class="ss">:except</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="ss">:no_release</span> <span class="o">=&gt;</span> <span class="kp">true</span> <span class="p">}</span>
      <span class="n">servers</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">server</span><span class="o">|</span>
        <span class="n">run_locally</span> <span class="s2">"rsync -av ./public/</span><span class="si">#{</span><span class="n">assets_prefix</span><span class="si">}</span><span class="s2">/ </span><span class="si">#{</span><span class="n">user</span><span class="si">}</span><span class="s2">@</span><span class="si">#{</span><span class="n">server</span><span class="si">}</span><span class="s2">:</span><span class="si">#{</span><span class="n">current_path</span><span class="si">}</span><span class="s2">/public/</span><span class="si">#{</span><span class="n">assets_prefix</span><span class="si">}</span><span class="s2">/"</span>
      <span class="k">end</span>
      <span class="n">run_locally</span> <span class="s2">"rm -rf public/</span><span class="si">#{</span><span class="n">assets_prefix</span><span class="si">}</span><span class="s2">"</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div> <p class="panel callout radius">If you’re a Windows user you can obtain <code>rsync</code> binaries <a href="http://www.rsync.net/resources/howto/windows_rsync.html">here</a>. Just add the <code>cwRsync/bin</code> folder to your system path and everything will be peaches.</p> <p>To make sure assets are compiles we need to call <code>deploy:assets:precompile</code> after each deployment. The order in which the task is called is no so critical here since Rails will be compiling assets from the local repository, but just in case anything else fails it would be best to call it after other tasks so we won’t have run a costly task for nothing.</p> <p>A good time to run the task is after <code>deploy:finalize_update</code> like so:</p> <div class=highlight><pre class="highlight ruby"><code><span class="n">after</span> <span class="s2">"deploy:finalize_update"</span><span class="p">,</span> <span class="s2">"deploy:assets:precompile"</span>
</code></pre></div> </body></html> </div> </div> <div class="large-4 columns"> <div class=sidebar> <div class="sidebar-section ad ad-300x250 sidebar-float"> <ins class=adsbygoogle style="display:inline-block;width:300px;height:600px" data-ad-client=ca-pub-1397369873900370 data-ad-slot=7510590887></ins> <script>
                (adsbygoogle = window.adsbygoogle || []).push({});
                </script> </div> </div> </div> </article> <div class=row> <div class=social-buttons> <ul> <li> <a href="http://twitter.com/share" class="socialite twitter-share" data-text="Precompiling Assets for Large Rails Deployments with Capistrano" data-url="https://sourcey.com/precompiling-assets-for-large-rails-deployments-with-capistrano/" data-count=vertical rel=nofollow target=_blank><span class=vhidden>Share on Twitter</span></a> </li> <li> <a href="https://plus.google.com/share?url=https://sourcey.com/precompiling-assets-for-large-rails-deployments-with-capistrano/" class="socialite googleplus-one" data-size=tall data-href="https://sourcey.com/precompiling-assets-for-large-rails-deployments-with-capistrano/" rel=nofollow target=_blank><span class=vhidden>Share on Google+</span></a> </li> <li> <a href="http://www.facebook.com/sharer.php?u=https://sourcey.com/precompiling-assets-for-large-rails-deployments-with-capistrano/&amp;t=Precompiling Assets for Large Rails Deployments with Capistrano" class="socialite facebook-like" data-href="https://sourcey.com/precompiling-assets-for-large-rails-deployments-with-capistrano/" data-send=false data-layout=box_count data-width=60 data-show-faces=false rel=nofollow target=_blank><span class=vhidden>Share on Facebook</span></a> </li> <li> <a href="http://www.linkedin.com/shareArticle?mini=true&amp;url=https://sourcey.com/precompiling-assets-for-large-rails-deployments-with-capistrano/&amp;title=Precompiling Assets for Large Rails Deployments with Capistrano" class="socialite linkedin-share" data-url="https://sourcey.com/precompiling-assets-for-large-rails-deployments-with-capistrano/" data-counter=top rel=nofollow target=_blank><span class=vhidden>Share on LinkedIn</span></a> </li> </ul> </div> </div> <div id=disqus_thread></div> <script>
          /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
          var disqus_shortname = 'sourcey'; // required: replace example with your forum shortname

          /* * * DON'T EDIT BELOW THIS LINE * * */
          (function() {
              var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
              dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
              (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
          })();
      </script> <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript" rel=nofollow>comments powered by Disqus.</a></noscript> <a href="http://disqus.com" rel=nofollow class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a> </div> <footer id=footer> <div class="row show-for-large-up"> <div class="ad ad-720x90 text-center"> <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script> <ins class=adsbygoogle style="display:inline-block;width:728px;height:90px" data-ad-client=ca-pub-1397369873900370 data-ad-slot=8042301285></ins> <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
          </script> </div> </div> <p> As with all business minded artists, we have fought the inevitable battle of conformity vs expression, and have emerged victorious with sanity intact to plunder the digiverse in search of new and interesting challenges. For more information, or a quote, drop us an email and tell us what you're working on. </p> <p>&copy; 2016 Sourcey<p> </footer> </body> </html>